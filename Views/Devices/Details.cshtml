@model Winedge.Models.Device

@{
    ViewData["Title"] = "Detalhes do Dispositivo";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewData["Title"]</h2>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">

    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i id="chartIcon" class="bi bi-thermometer-half text-danger"></i> Monitoramento
                </h5>
                <select id="dataType" class="form-select w-auto">
                    <option value="temperature" selected>Temperatura (°C)</option>
                    <option value="humidity">Umidade (%)</option>
                    <option value="luminosity">Luminosidade (lx)</option>
                </select>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle-fill"></i> Informações
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0 align-items-center">
                    <dt class="col-sm-5">ID</dt>
                    <dd class="col-sm-7">@Model.Id</dd>

                    <dt class="col-sm-5">Dispositivo</dt>
                    <dd class="col-sm-7 fw-bold">@Model.DeviceName</dd>

                    <hr class="my-2 text-muted" />

                    <dt class="col-sm-5">Max Temp.</dt>
                    <dd class="col-sm-7">
                        <span id="tempLimitBadge">
                            @if (Model.TemperatureLimit.HasValue)
                            {
                                <span class="badge bg-danger-subtle text-danger border border-danger">
                                    <i class="bi bi-thermometer-high"></i> @Model.TemperatureLimit °C
                                </span>
                            }
                            else
                            {
                                <span class="text-muted small fst-italic">Não definido</span>
                            }
                        </span>

                        <span id="tempAlert" class="ms-2 fw-bold text-danger" style="display:none;">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span class="alert-blink">ALERTA!</span>
                        </span>
                    </dd>


                    <dt class="col-sm-5">Max Umid.</dt>
                    <dd class="col-sm-7">
                        @if (Model.HumidityLimit.HasValue)
                        {
                            <span class="badge bg-primary-subtle text-primary border border-primary">
                                <i class="bi bi-droplet-fill"></i> @Model.HumidityLimit %
                            </span>
                        }
                        else
                        {
                            <span class="text-muted small fst-italic">Não definido</span>
                        }
                        <span id="humAlert" class="ms-2 fw-bold text-danger" style="display:none;">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span class="alert-blink">ALERTA!</span>
                        </span>

                    </dd>

                    <dt class="col-sm-5">Max Luz</dt>
                    <dd class="col-sm-7">
                        @if (Model.LuminosityLimit.HasValue)
                        {
                            <span class="badge bg-warning-subtle text-dark border border-warning">
                                <i class="bi bi-sun-fill"></i> @Model.LuminosityLimit lx
                            </span>
                        }
                        else
                        {
                            <span class="text-muted small fst-italic">Não definido</span>
                        }
                        <span id="lumAlert" class="ms-2 fw-bold text-danger" style="display:none;">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <span class="alert-blink">ALERTA!</span>
                        </span>

                    </dd>
                </dl>
            </div>
            <div class="card-footer bg-light text-end">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                    <i class="bi bi-pencil-fill"></i> Editar
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-geo-alt-fill"></i> Localização
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <small class="text-muted">Lat: @Model.Latitude | Lng: @Model.Longitude</small>
                </p>
                <div id="map" style="height: 300px; width: 100%; border-radius: 10px;"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-sun-fill"></i> Previsão Local
                </h5>
            </div>
            <div class="card-body" id="weatherBox" style="height: 342px;">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Carregando clima...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // 1. DADOS INICIAIS E CONFIGURAÇÃO
            // Mapeamento dos limites
            const deviceLimits = {
                temperature: @(Model.TemperatureLimit?.ToString() ?? "null"),
                humidity: @(Model.HumidityLimit?.ToString() ?? "null"),
                luminosity: @(Model.LuminosityLimit?.ToString() ?? "null")
            };

            // Mapeamento dos IDs de Alerta
            const alertIds = {
                temperature: "tempAlert",
                humidity: "humAlert",
                luminosity: "lumAlert"
            };

            const deviceId = '@Model.DeviceName';
            const MAX_POINTS = 100;
            const UPDATE_INTERVAL_MS = 2000;
            let lastTimestampMs = null;
            let updateInterval;
            let alertInterval;


            const lat = "@Model.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture)";
            const lng = "@Model.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)";
            const map = L.map('map').setView([parseFloat(lat), parseFloat(lng)], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            L.marker([parseFloat(lat), parseFloat(lng)]).addTo(map).bindPopup("@Model.DeviceName");

            const ctx = document.getElementById('deviceChart').getContext('2d');
            const chartThemes = {
                temperature: { iconClass: "bi-thermometer-half", colorHex: "#dc3545", rgbaStart: "rgba(220, 53, 69, 0.4)", rgbaEnd: "rgba(220, 53, 69, 0)", iconColorClass: "text-danger" },
                humidity: { iconClass: "bi-droplet-half", colorHex: "#007bff", rgbaStart: "rgba(0, 123, 255, 0.4)", rgbaEnd: "rgba(0, 123, 255, 0)", iconColorClass: "text-primary" },
                luminosity: { iconClass: "bi-sun-fill", colorHex: "#ffc107", rgbaStart: "rgba(255, 193, 7, 0.4)", rgbaEnd: "rgba(255, 193, 7, 0)", iconColorClass: "text-warning" }
            };
            const initialTheme = chartThemes.temperature;
            const initialGradient = ctx.createLinearGradient(0, 0, 0, 350);
            initialGradient.addColorStop(0, initialTheme.rgbaStart);
            initialGradient.addColorStop(1, initialTheme.rgbaEnd);

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Leitura', data: [], borderWidth: 2, borderColor: initialTheme.colorHex, backgroundColor: initialGradient, fill: true, tension: 0.3, pointRadius: 0, order: 2 },
                        { label: 'Limite', data: [], borderColor: '#6c757d', borderWidth: 1, borderDash: [5, 5], pointRadius: 0, fill: false, order: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: {
                        x: { title: { display: true, text: 'Tempo' } },
                        y: { title: { display: true, text: 'Temperatura (°C)' }, beginAtZero: false }
                    },
                    plugins: { legend: { display: true, position: 'top', align: 'end', labels: { boxWidth: 10 } } }
                }
            });

            // --- Funções Auxiliares ---
            function parseTimestampMs(ts) {
                const ms = Date.parse(ts);
                return Number.isFinite(ms) ? ms : null;
            }

            function getCurrentLimitValue() {
                const type = document.getElementById("dataType").value;
                const limit = deviceLimits[type];
                return (limit === 'null' || limit === null) ? null : Number(limit);
            }

            // FUNÇÃO DE ALERTA
            function toggleSingleAlert(type, value) {
                const limit = deviceLimits[type];
                const alertEl = document.getElementById(alertIds[type]);

                if (limit !== 'null' && limit !== null && value > Number(limit)) {
                    // Valor ultrapassou o limite: Mostra alerta piscante
                    alertEl.style.display = "inline-block";
                } else {
                    // Limite OK ou não definido: Esconde alerta
                    alertEl.style.display = "none";
                }
            }

            // ENVIA O COMANDO DO BUZZER
            async function sendBuzzerCommand(command) {
                try {
                    await fetch(`/Devices/SendCommand?deviceId=@Model.Id&command=${command}`, {
                        method: "POST"
                    });
                } catch (e) {
                    console.error("Erro ao enviar comando do buzzer:", e);
                }
            }


            // BUSCA TODOS OS ALERTAS
            async function checkAllLimits() {
            let anyExceeded = false;

            for (const type of Object.keys(deviceLimits)) {
                try {
                    const res = await fetch(`/api/sthcomet/${deviceId}/latest?attribute=${type}&lastN=1`);
                    const json = await res.json();

                    const lastValue = Number(json.values.at(-1)?.value);
                    const limit = deviceLimits[type];

                    if (!Number.isFinite(lastValue)) continue;

                    toggleSingleAlert(type, lastValue);

                    if (limit !== 'null' && limit !== null && lastValue > Number(limit)) {
                        anyExceeded = true;
                    }

                } catch (err) {
                    console.error(`Erro ao checar limite de ${type}`, err);
                }
            }

            // CONTROLE DO BUZZER AUTOMÁTICO
            if (anyExceeded) {
                sendBuzzerCommand("buzzer_on");
            } else {
                sendBuzzerCommand("buzzer_off");
            }
        }


            // --- Lógica de Dados (loadInitialData e updateLastPoint) ---

            async function loadInitialData() {
                const type = document.getElementById("dataType").value;
                try {
                    const res = await fetch(`/api/sthcomet/${deviceId}/latest?attribute=${type}`);
                    const json = await res.json();
                    if (!json.values?.length) { chart.data.labels = []; chart.data.datasets[0].data = []; chart.data.datasets[1].data = []; chart.update(); return; };
                    chart.data.labels = json.values.map(v => new Date(parseTimestampMs(v.timestamp)).toLocaleTimeString());
                    chart.data.datasets[0].data = json.values.map(v => Number(v.value));
                    const limit = getCurrentLimitValue();
                    if (limit !== null) { chart.data.datasets[1].data = new Array(json.values.length).fill(limit); chart.data.datasets[1].hidden = false; } else { chart.data.datasets[1].data = []; chart.data.datasets[1].hidden = true; }
                    lastTimestampMs = parseTimestampMs(json.values.at(-1).timestamp);
                    chart.update();
                } catch (err) { console.error(err); }
            }

            async function updateLastPoint() {
                const type = document.getElementById("dataType").value;
                try {
                    const res = await fetch(`/api/sthcomet/${deviceId}/latest?attribute=${type}`);
                    const json = await res.json();
                    if (!json.values?.length) return;
                    const last = json.values.at(-1);
                    const lastMs = parseTimestampMs(last.timestamp);
                    const currentValue = Number(last.value);
                    if (lastTimestampMs && lastMs <= lastTimestampMs) return;

                    chart.data.labels.push(new Date(lastMs).toLocaleTimeString());
                    chart.data.datasets[0].data.push(currentValue);
                    chart.data.datasets[1].data.push(getCurrentLimitValue());

                    lastTimestampMs = lastMs;

                    if (chart.data.labels.length > MAX_POINTS) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                        chart.data.datasets[1].data.shift();
                    }
                    chart.update();

                } catch (err) { console.error(err); }
            }

            // --- Eventos ---
            document.getElementById("dataType").addEventListener("change", (e) => {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.data.datasets[1].data = [];
                lastTimestampMs = null;

                // O checkAllLimits() vai gerenciar o display dos 3 de uma vez.

                const selectedType = e.target.value;
                const selectedOptionText = e.target.options[e.target.selectedIndex].text;
                const theme = chartThemes[selectedType];

                // Atualiza Tema (visualmente)
                const iconEl = document.getElementById("chartIcon");
                iconEl.className = "bi " + theme.iconClass + " " + theme.iconColorClass;
                const newGradient = ctx.createLinearGradient(0, 0, 0, 350);
                newGradient.addColorStop(0, theme.rgbaStart);
                newGradient.addColorStop(1, theme.rgbaEnd);

                chart.data.datasets[0].borderColor = theme.colorHex;
                chart.data.datasets[0].backgroundColor = newGradient;
                chart.data.datasets[0].label = selectedOptionText;
                chart.options.scales.y.title.text = selectedOptionText;
                chart.options.scales.y.beginAtZero = (selectedType !== 'temperature');

                chart.update('none');
                loadInitialData();
            });


            // 1. Inicia o gráfico
            loadInitialData();
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(updateLastPoint, UPDATE_INTERVAL_MS);

            // 2. check de alertas
            if (alertInterval) clearInterval(alertInterval);
            alertInterval = setInterval(checkAllLimits, UPDATE_INTERVAL_MS);


            // 4. CLIMA 
            async function loadWeather() {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}` + `&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code` + `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max` + `&timezone=America/Sao_Paulo`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    const c = data.current; const d = data.daily;
                    const wText = weatherCodeToText(c.weather_code);
                    document.getElementById("weatherBox").innerHTML = `
                        <div class="row h-100 align-items-center">
                            <div class="col-6 border-end text-center">
                                <div class="mb-2"><strong class="fs-5">${wText}</strong></div>
                                <div class="display-4 fw-bold text-primary">${c.temperature_2m}°C</div>
                                <div class="text-muted small">Sensação: ${c.apparent_temperature}°C</div>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2 d-flex justify-content-between"><span>Umidade:</span> <strong>${c.relative_humidity_2m}%</strong></li>
                                    <li class="mb-2 d-flex justify-content-between text-danger"><span>Máxima:</span> <strong>${d.temperature_2m_max[0]}°C</strong></li>
                                    <li class="mb-2 d-flex justify-content-between text-primary"><span>Mínima:</span> <strong>${d.temperature_2m_min[0]}°C</strong></li>
                                    <li class="d-flex justify-content-between"><span>Chuva:</span> <strong>${d.precipitation_probability_max[0]}%</strong></li>
                                </ul>
                            </div>
                        </div>`;
                } catch(e) {
                    document.getElementById("weatherBox").innerHTML = "<p class='text-danger text-center pt-5'>Erro no clima.</p>";
                }
            }
            function weatherCodeToText(code) {
                 const map = { 0:"Céu limpo",1:"Claro",2:"Parcial",3:"Nublado",45:"Nevoeiro",51:"Garoa",53:"Garoa",55:"Garoa",61:"Chuva",63:"Chuva",65:"Chuva Forte",80:"Chuva",95:"Tempestade" };
                 return map[code] ?? "Desconhecido";
            }
            loadWeather();
        });
    </script>
}