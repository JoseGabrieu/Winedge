@model Winedge.Models.UserDevice

@{
    ViewData["Title"] = "Detalhes do Dispositivo";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>@ViewData["Title"]</h2>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="row">

    <!-- GRÁFICO -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart-line-fill"></i> Monitoramento em tempo real
                </h5>

                <!-- seletor de tipo de gráfico -->
                <select id="dataType" class="form-select w-auto">
                    <option value="temperature" selected>Temperatura (°C)</option>
                    <option value="humidity">Umidade (%)</option>
                    <option value="luminosity">Luminosidade (lx)</option>
                </select>
            </div>

            <div class="card-body">
                <div style="position: relative; height: 350px;">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- INFORMAÇÕES -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle-fill"></i> Informações
                </h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">ID</dt>
                    <dd class="col-sm-8">@Model.Id</dd>

                    <dt class="col-sm-4">Usuário</dt>
                    <dd class="col-sm-8">@Model.User</dd>

                    <dt class="col-sm-4">Dispositivo</dt>
                    <dd class="col-sm-8">@Model.Device</dd>
                </dl>
            </div>

            @if (User.IsInRole("admin"))
            {
                <div class="card-footer bg-light text-end">
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                        <i class="bi bi-pencil-fill"></i> Editar
                    </a>
                </div>
            }
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('deviceChart').getContext('2d');
    const deviceId = '@Model.Device';
    const MAX_POINTS = 100;
    const UPDATE_INTERVAL_MS = 2000;

    const gradient = ctx.createLinearGradient(0, 0, 0, 350);
    gradient.addColorStop(0, 'rgba(0,123,255,0.4)');
    gradient.addColorStop(1, 'rgba(0,123,255,0)');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura (°C)',
                data: [],
                borderWidth: 2,
                borderColor: '#007bff',
                backgroundColor: gradient,
                fill: true,
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                x: { title: { display: true, text: 'Tempo' } },
                y: { title: { display: true, text: 'Temperatura (°C)' }, beginAtZero: true }
            },
            plugins: { legend: { display: false } }
        }
    });

    let lastTimestampMs = null;
    let isUpdating = false;

    function parseTimestampMs(ts) {
        const ms = Date.parse(ts);
        return Number.isFinite(ms) ? ms : null;
    }

    async function loadInitialData() {
        const selectedType = document.getElementById("dataType").value;

        try {
            isUpdating = true;

            const res = await fetch(`/api/sthcomet/${deviceId}/latest?attribute=${selectedType}`);
            if (!res.ok) throw new Error("Erro ao obter histórico");

            const json = await res.json();

            if (!json.values || !json.values.length) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
                lastTimestampMs = null;
                return;
            }

            const labels = json.values.map(v => {
                const ms = parseTimestampMs(v.timestamp);
                return new Date(ms).toLocaleTimeString();
            });

            const values = json.values.map(v => Number(v.value));

            chart.data.labels = labels;
            chart.data.datasets[0].data = values;

            // define timestamp do último registro
            lastTimestampMs = parseTimestampMs(
                json.values[json.values.length - 1].timestamp
            );

            chart.update();
        } catch (err) {
            console.error("Erro em loadInitialData:", err);
        } finally {
            isUpdating = false;
        }
    }

    async function updateLastPoint() {
        if (isUpdating) return;

        const selectedType = document.getElementById("dataType").value;

        try {
            isUpdating = true;

            const res = await fetch(`/api/sthcomet/${deviceId}/latest?attribute=${selectedType}`);
            if (!res.ok) return;

            const json = await res.json();
            if (!json.values || !json.values.length) return;

            const last = json.values[json.values.length - 1];
            const lastMs = parseTimestampMs(last.timestamp);

            if (lastTimestampMs !== null && lastMs <= lastTimestampMs) {
                return; // já temos esse ponto
            }

            const label = new Date(lastMs).toLocaleTimeString();
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(Number(last.value));

            lastTimestampMs = lastMs;

            if (chart.data.labels.length > MAX_POINTS) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        } catch (err) {
            console.error("Erro em updateLastPoint:", err);
        } finally {
            isUpdating = false;
        }
    }

    // Executa ao carregar a página
    (async () => {
        await loadInitialData();
        setInterval(updateLastPoint, UPDATE_INTERVAL_MS);
    })();

    // Troca de tipo: recarregar tudo
    document.getElementById("dataType").addEventListener("change", (e) => {
        const selectedText = e.target.options[e.target.selectedIndex].text;

        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.data.datasets[0].label = selectedText;
        chart.options.scales.y.title.text = selectedText;

        chart.update();
        loadInitialData();
    });
</script>
